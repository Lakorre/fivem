<script>
    // إعدادات زر المنيو
    let menuToggleKey = 'g'; // زر G الافتراضي
    
    // وظيفة فتح/إغلاق المنيو
    function toggleMenu() {
        const mainMenu = document.getElementById('mainMenu');
        const submenus = document.querySelectorAll('.submenu-container');
        
        if (mainMenu.classList.contains('hidden')) {
            // إظهار المنيو
            mainMenu.classList.remove('hidden');
            submenus.forEach(menu => menu.classList.add('hidden'));
            currentView = 'main';
            selectedIndex = 0;
            updateMenuItems();
            console.log('Menu opened');
        } else {
            // إخفاء المنيو
            mainMenu.classList.add('hidden');
            submenus.forEach(menu => menu.classList.add('hidden'));
            console.log('Menu closed');
        }
        
        // إرسال حالة المنيو إلى Lua
        fetch(`https://${GetParentResourceName()}/executeCommand`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify({
                command: 'menuToggled',
                parameters: { isOpen: !mainMenu.classList.contains('hidden') }
            })
        });
    }

    // مستمع لوحة المفاتيح لزر G
    document.addEventListener('keydown', function(event) {
        // زر G لفتح/إغلاق المنيو
        if (event.key.toLowerCase() === 'g' || event.code === 'KeyG') {
            event.preventDefault();
            toggleMenu();
            return;
        }
        
        // الأزرار الأخرى للتنقل (فقط إذا كان المنيو مفتوح)
        if (!document.getElementById('mainMenu').classList.contains('hidden')) {
            if (['ArrowUp', 'ArrowDown', 'Enter', 'Backspace', 'q', 'Q', 'e', 'E', 'Escape'].includes(event.key)) {
                event.preventDefault();
                
                let key = event.key;
                if (key === 'q' || key === 'Q') key = 'KeyQ';
                if (key === 'e' || key === 'E') key = 'KeyE';
                if (key === 'Backspace') key = 'Backspace';
                if (key === 'Escape') key = 'Escape';
                
                handleKeyPress(key);
            }
        }
    });

    // استقبال الأوامر من Lua
    window.addEventListener('message', function(event) {
        const data = event.data;
        
        if (data.action === 'showMenu') {
            document.getElementById('mainMenu').classList.remove('hidden');
            currentView = 'main';
            selectedIndex = 0;
            updateMenuItems();
        }
        else if (data.action === 'hideMenu') {
            document.getElementById('mainMenu').classList.add('hidden');
            document.querySelectorAll('.submenu-container').forEach(menu => {
                menu.classList.add('hidden');
            });
        }
        else if (data.action === 'keyPress') {
            handleKeyPress(data.key);
        }
        else if (data.action === 'toggleMenu') {
            toggleMenu();
        }
    });

    // إرسال الأوامر إلى Lua عند النقر على العناصر
    function executeLuaCommand(command, parameters = {}) {
        fetch(`https://${GetParentResourceName()}/executeCommand`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
            },
            body: JSON.stringify({
                command: command,
                parameters: parameters
            })
        }).then(resp => resp.json()).then(resp => console.log(resp));
    }

    // تعديل دالة toggleOption لإرسال الأوامر إلى Lua
    function toggleOption(element, option) {
        element.classList.toggle('active');
        const state = element.classList.contains('active');
        toggleStates[option] = state;
        
        // إرسال إلى Lua
        executeLuaCommand('toggleOption', {
            option: option,
            state: state
        });
    }

    // إخفاء المنيو في البداية
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('mainMenu').classList.add('hidden');
        console.log('MACHO MENU loaded - Press G to open');
    });
</script>
